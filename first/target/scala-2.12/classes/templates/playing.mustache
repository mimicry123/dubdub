<!DOCTYPE html>
<html>

<body>
<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
<div id="player"></div>
<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script src="http://WebRTC-Experiment.com/RecordRTC.js"></script>
<script>
        var session = {
            audio: true,
            video: false
        };
        var recordRTC = null;


        var formData = null


        function getId(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);

            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return 'error';
            }
        }
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: getId('{{link}}'),
                playerVars: {
                    'autoplay': 0,
                    'controls': 0,
                    'enablejsapi': 1,
                    'showinfo': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }


        function onPlayerReady(event) {
            console.log("PLAYER READY")
            $("iframe").hide();
        }

        var done = false;

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                console.log("Checking how many times")
            }
        }

        function preview() {
            var video = document.querySelector('video');
            var blob = recordRTC.getBlob();
            video.src = URL.createObjectURL(blob);
            playVideo();
            video.play();
        }


        function upload() {
            $.ajax({
                type: 'POST',
                url: 'wave/webm/{{videoId}}',
                data: formData,
                contentType: false,
                cache: false,
                processData: false,
                success: function(){
                window.location.href = "/upload"
                }
            })
        }

        function playVideo() {
            player.mute();
            player.playVideo();
            $("iframe").show();
            navigator.getUserMedia(session, function(mediaStream) {
                recordRTC = RecordRTC(mediaStream, {
                    type: "audio",
                    recorderType: MediaStreamRecorder,
                    disableLogs: true,
                    numberOfAudioChannels: 2,
                    bufferSize: 16384,
                    sampleRate: 44100,
                    desiredSampRate: 44100
                });
                recordRTC.startRecording();
            }, onError);
        }

        function onError() {
            console.log("Error")
        }

        function stopVideo() {
            player.stopVideo();
            $("iframe").hide();
            recordRTC.stopRecording(function(audioURL) {
                var fileType = 'audio'; // or "audio"
                var fileName = 'ABCDEF.webm'; // or "wav"
                var blob = recordRTC.getBlob();
                var file = new File([blob], "chumma", {
                    type: 'audio/webm'
                });
                formData = new FormData();
                formData.append('audio', file, 'random.webm');

            });
        }
    </script>
<input type="button" value="Play" onclick="playVideo()">
<input type="button" value="Stop" onclick="stopVideo()">
<input type="button" value="Preview" onclick="preview()">
<input type="button" value="Upload" onclick="upload()">
<video controls autoplay></video>
</body>

</html>